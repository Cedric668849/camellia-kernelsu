name: Build Camellia KernelSU Kernel

on:
  workflow_dispatch:
    inputs:
      kernelsu_version:
        description: 'KernelSUç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        echo "===== æ¸…ç†å‰ç£ç›˜ä½¿ç”¨ ====="
        df -h

        echo "æ¸…ç†ä¸éœ€è¦çš„è½¯ä»¶..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/graalvm/
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/lib/node_modules

        echo "æ¸…ç†APTç¼“å­˜..."
        sudo apt-get clean
        sudo apt-get autoremove -y

        echo "===== æ¸…ç†åç£ç›˜ä½¿ç”¨ ====="
        df -h
        echo "å¯ç”¨ç©ºé—´: $(df -h / | awk 'NR==2 {print $4}')"

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          git gnupg gperf liblz4-tool \
          libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python3-pip device-tree-compiler wget \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

        echo "GCCç‰ˆæœ¬:"
        aarch64-linux-gnu-gcc --version

    - name: è®¾ç½®ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "2G"

    - name: ä¸‹è½½å†…æ ¸æºç ï¼ˆä½¿ç”¨å‹ç¼©åŒ…ï¼‰
      run: |
        cd $HOME
        echo "å¼€å§‹ä¸‹è½½å†…æ ¸æºç å‹ç¼©åŒ…..."

        # ç›´æ¥ä¸‹è½½ZIPå‹ç¼©åŒ…
        wget -q --show-progress --timeout=300 \
          https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
          -O kernel.zip || {
            echo "GitHubä¸‹è½½å¤±è´¥ï¼Œå°è¯•åŠ é€Ÿé“¾æ¥..."
            wget -q --show-progress --timeout=300 \
              https://ghproxy.com/https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
              -O kernel.zip || {
                echo "å†æ¬¡å°è¯•é•œåƒ..."
                wget -q --show-progress --timeout=300 \
                  https://gh.api.99988866.xyz/https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
                  -O kernel.zip
              }
          }

        echo "è§£å‹å†…æ ¸æºç ..."
        unzip -q kernel.zip
        mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel
        rm kernel.zip

        echo "å†…æ ¸æºç å‡†å¤‡å®Œæˆ"
        ls -la kernel/

    - name: ä¸‹è½½KernelSU
      run: |
        cd $HOME
        echo "ä¸‹è½½KernelSU..."

        if [ -n "${{ github.event.inputs.kernelsu_version }}" ]; then
          wget -q --show-progress \
            https://github.com/tiann/KernelSU/archive/refs/tags/${{ github.event.inputs.kernelsu_version }}.zip \
            -O kernelsu.zip || \
          wget -q --show-progress \
            https://ghproxy.com/https://github.com/tiann/KernelSU/archive/refs/tags/${{ github.event.inputs.kernelsu_version }}.zip \
            -O kernelsu.zip
        else
          wget -q --show-progress \
            https://github.com/tiann/KernelSU/archive/refs/heads/main.zip \
            -O kernelsu.zip || \
          wget -q --show-progress \
            https://ghproxy.com/https://github.com/tiann/KernelSU/archive/refs/heads/main.zip \
            -O kernelsu.zip
        fi

        unzip -q kernelsu.zip
        mv KernelSU-* KernelSU
        rm kernelsu.zip

        echo "KernelSUå‡†å¤‡å®Œæˆ"
        ls -la KernelSU/kernel/

    - name: é›†æˆKernelSUåˆ°å†…æ ¸
      run: |
        cd $HOME/kernel

        # å¤åˆ¶KernelSUæ¨¡å—åˆ°å†…æ ¸
        cp -r $HOME/KernelSU/kernel drivers/kernelsu

        # éªŒè¯
        if [ -d "drivers/kernelsu" ]; then
          echo "âœ… KernelSUé›†æˆæˆåŠŸ"
          ls -la drivers/kernelsu/
        else
          echo "âŒ KernelSUé›†æˆå¤±è´¥"
          exit 1
        fi

        # ä¿®æ”¹Makefile
        if ! grep -q "kernelsu" drivers/Makefile; then
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          echo "å·²æ·»åŠ KernelSUåˆ°Makefile"
        fi

        # ä¿®æ”¹Kconfig
        if ! grep -q "kernelsu" drivers/Kconfig; then
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo "å·²æ·»åŠ KernelSUåˆ°Kconfig"
        fi

        echo "KernelSUé›†æˆé…ç½®å®Œæˆ"

    - name: ç²¾ç¡®ä¿®å¤å¤´æ–‡ä»¶é—®é¢˜
      run: |
        cd $HOME/kernel

        echo "===== å¼€å§‹ç²¾ç¡®ä¿®å¤å¤´æ–‡ä»¶é—®é¢˜ ====="

        # ä¿®å¤å…·ä½“çš„æ–‡ä»¶ï¼Œé¿å…è¯¯ä¼¤
        echo "ä¿®å¤fs/sdcardfs/dentry.c..."
        if [ -f "fs/sdcardfs/dentry.c" ]; then
          # åªä¿®å¤ç‰¹å®šçš„é”™è¯¯è¡Œ
          sed -i 's/#include <linux\/ctype\.h"/#include <linux\/ctype.h>/g' fs/sdcardfs/dentry.c
        fi

        echo "ä¿®å¤drivers/cpuidle/cpuidle.c..."
        if [ -f "drivers/cpuidle/cpuidle.c" ]; then
          # åªä¿®å¤ç‰¹å®šçš„é”™è¯¯è¡Œ
          sed -i 's/#include <linux\/clockchips\.h"/#include <linux\/clockchips.h>/g' drivers/cpuidle/cpuidle.c
        fi

        echo "ä¿®å¤drivers/clk/mediatek/clkdbg-mt6833.c..."
        if [ -f "drivers/clk/mediatek/clkdbg-mt6833.c" ]; then
          sed -i 's/#include <clk-mux\.h>/#include "clk-mux.h"/g' drivers/clk/mediatek/clkdbg-mt6833.c
        fi

        echo "ä¿®å¤drivers/cpuidle/cpuidle-mediatek.c..."
        if [ -f "drivers/cpuidle/cpuidle-mediatek.c" ]; then
          sed -i 's/#include <dt_idle_states\.h>/#include "dt_idle_states.h"/g' drivers/cpuidle/cpuidle-mediatek.c
        fi

        echo "ä¿®å¤drivers/devfreq/helio-dvfsrc-v3/helio-dvfsrc-qos.c..."
        if [ -f "drivers/devfreq/helio-dvfsrc-v3/helio-dvfsrc-qos.c" ]; then
          sed -i 's/#include <helio-dvfsrc-qos\.h>/#include "helio-dvfsrc-qos.h"/g' drivers/devfreq/helio-dvfsrc-v3/helio-dvfsrc-qos.c
        fi

        # æŸ¥æ‰¾å¹¶ä¿®å¤æ‰€æœ‰æŸåçš„å¤´æ–‡ä»¶å¼•ç”¨ï¼ˆç»“å°¾æ˜¯"è€Œä¸æ˜¯>ï¼‰
        echo "æŸ¥æ‰¾å¹¶ä¿®å¤æ‰€æœ‰æŸåçš„å¤´æ–‡ä»¶å¼•ç”¨..."
        find . -name "*.c" -type f | while read file; do
          # ä¿®å¤ä»¥"ç»“å°¾çš„includeè¯­å¥
          if grep -q '#include.*\.h"$' "$file"; then
            echo "ä¿®å¤æ–‡ä»¶: $file"
            # å¤‡ä»½åŸæ–‡ä»¶
            cp "$file" "${file}.bak"
            # ä¿®å¤é”™è¯¯çš„å¼•å·
            sed -i 's/#include <\([^>]*\)\.h"/#include <\1.h>/g' "$file"
            sed -i 's/#include "\([^"]*\)\.h"/#include "\1.h"/g' "$file"
          fi
        done

        echo "===== å¤´æ–‡ä»¶ä¿®å¤å®Œæˆ ====="

    - name: é…ç½®å†…æ ¸ï¼ˆæœ€å°åŒ–é…ç½®ï¼‰
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        # ä½¿ç”¨camelliaé»˜è®¤é…ç½®
        echo "åº”ç”¨é»˜è®¤é…ç½®..."
        make camellia_defconfig

        echo "===== å¼€å§‹æœ€å°åŒ–é…ç½® ====="

        # ç¦ç”¨æ‰€æœ‰å¯èƒ½æœ‰é—®é¢˜çš„å¯é€‰åŠŸèƒ½
        echo "ç¦ç”¨SDCARD FS..."
        scripts/config --disable CONFIG_SDCARD_FS

        echo "ç¦ç”¨MT6833æ—¶é’Ÿé©±åŠ¨..."
        scripts/config --disable CONFIG_COMMON_CLK_MT6833
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_AUDIO
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_CAMSYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_IMGSYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_IPESYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_MDPSYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_MFGCFG
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_MMSYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_VDECSYS
        scripts/config --disable CONFIG_COMMON_CLK_MT6833_VENCSYS

        echo "ç¦ç”¨CPUIDLE..."
        scripts/config --disable CONFIG_CPU_IDLE
        scripts/config --disable CONFIG_CPU_IDLE_GOV_LADDER
        scripts/config --disable CONFIG_CPU_IDLE_GOV_MENU
        scripts/config --disable CONFIG_MTK_IDLE_BALANCE_ENHANCEMENT
        scripts/config --disable CONFIG_MTK_CPUIDLE
        scripts/config --disable CONFIG_ARM_CPUIDLE

        echo "ç¦ç”¨DVFSRC..."
        scripts/config --disable CONFIG_MTK_DVFSRC
        scripts/config --disable CONFIG_MTK_DVFSRC_DEVFREQ
        scripts/config --disable CONFIG_HELIO_DVFSRC_V3
        scripts/config --disable CONFIG_ARM_MT6833_CPUFREQ
        scripts/config --disable CONFIG_ARM_MEDIATEK_CPUFREQ

        echo "ç¦ç”¨DEVFREQ..."
        scripts/config --disable CONFIG_PM_DEVFREQ
        scripts/config --disable CONFIG_DEVFREQ_GOV_SIMPLE_ONDEMAND
        scripts/config --disable CONFIG_DEVFREQ_GOV_PERFORMANCE
        scripts/config --disable CONFIG_DEVFREQ_GOV_POWERSAVE
        scripts/config --disable CONFIG_DEVFREQ_GOV_USERSPACE
        scripts/config --disable CONFIG_DEVFREQ_GOV_PASSIVE

        # ç¦ç”¨æ ˆä¿æŠ¤
        echo "ç¦ç”¨æ ˆä¿æŠ¤..."
        scripts/config --disable CONFIG_CC_STACKPROTECTOR_STRONG
        scripts/config --disable CONFIG_CC_STACKPROTECTOR
        scripts/config --disable CONFIG_STACKPROTECTOR
        scripts/config --disable CONFIG_STACKPROTECTOR_STRONG

        # å¯ç”¨KernelSUéœ€è¦çš„é€‰é¡¹
        echo "å¯ç”¨KernelSU..."
        scripts/config --enable CONFIG_KPROBES
        scripts/config --enable CONFIG_HAVE_KPROBES
        scripts/config --enable CONFIG_KPROBE_EVENTS
        scripts/config --enable CONFIG_MODULES
        scripts/config --enable CONFIG_MODULE_UNLOAD
        scripts/config --enable CONFIG_MODULE_FORCE_UNLOAD

        # æ·»åŠ KernelSUé…ç½®
        echo "CONFIG_KSU=y" >> .config
        echo "CONFIG_KSU_DEBUG=n" >> .config

        # æ›´æ–°é…ç½®
        make olddefconfig

        echo "===== é…ç½®å®Œæˆ ====="
        echo "éªŒè¯å…³é”®é…ç½®:"
        echo "KernelSU: $(grep CONFIG_KSU=y .config && echo 'å·²å¯ç”¨' || echo 'æœªå¯ç”¨')"
        echo "KPROBES: $(grep CONFIG_KPROBES=y .config && echo 'å·²å¯ç”¨' || echo 'æœªå¯ç”¨')"
        echo "SDCARD_FS: $(grep CONFIG_SDCARD_FS .config || echo 'å·²ç¦ç”¨')"
        echo "CPU_IDLE: $(grep CONFIG_CPU_IDLE .config || echo 'å·²ç¦ç”¨')"

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export KCFLAGS="-w"
        export CONFIG_CC_STACKPROTECTOR_STRONG=n

        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸ (ä½¿ç”¨ $(nproc) çº¿ç¨‹)..."
        echo "é¢„è®¡éœ€è¦15-25åˆ†é’Ÿ..."
        echo "================="

        # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘
        make mrproper

        # é‡æ–°é…ç½®ï¼ˆå› ä¸ºmrproperä¼šæ¸…é™¤é…ç½®ï¼‰
        make camellia_defconfig
        echo "CONFIG_KSU=y" >> .config
        make olddefconfig

        # ç¼–è¯‘å†…æ ¸é•œåƒ
        make -j$(nproc) Image.gz-dtb 2>&1 | tee compile.log | tail -n 100

        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "================="
          echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "================="
          echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
          echo "æ˜¾ç¤ºæœ€å100è¡Œç¼–è¯‘æ—¥å¿—ï¼š"
          tail -n 100 compile.log
          echo "å°è¯•æŸ¥æ‰¾å¯èƒ½çš„å†…æ ¸æ–‡ä»¶..."
          find . -name "Image*" -type f 2>/dev/null | head -20
          exit 1
        fi

    - name: æ‰“åŒ…ç¼–è¯‘äº§ç‰©
      run: |
        mkdir -p $HOME/output

        # å¤åˆ¶å†…æ ¸
        cp $HOME/kernel/arch/arm64/boot/Image.gz-dtb $HOME/output/
        echo "å†…æ ¸æ–‡ä»¶å¤§å°: $(ls -lh $HOME/output/Image.gz-dtb | awk '{print $5}')"

        # ä¸‹è½½boot.imgå¤„ç†å·¥å…·
        cd $HOME/output
        echo "ä¸‹è½½boot.imgå¤„ç†å·¥å…·..."
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk || \
        wget -q https://ghproxy.com/https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk

        unzip -q -j Magisk-26.4.apk 'lib/x86_64/libmagiskboot.so'
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
        rm Magisk-26.4.apk

        # åˆ›å»ºä½¿ç”¨è„šæœ¬
        cat > make_boot.sh << 'SCRIPT_END'
        #!/bin/bash
        echo "KernelSU Boot.img åˆ¶ä½œå·¥å…·"
        echo "========================="

        if [ ! -f boot.img ]; then
          echo "é”™è¯¯: è¯·å…ˆæ”¾å…¥åŸç‰ˆboot.img"
          exit 1
        fi

        ./magiskboot unpack boot.img
        cp Image.gz-dtb kernel
        ./magiskboot repack boot.img

        echo "å®Œæˆ! ç”Ÿæˆ: new-boot.img"
        echo "åˆ·å…¥: fastboot flash boot new-boot.img"
        SCRIPT_END
        chmod +x make_boot.sh

        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        cat > README.txt << 'README_END'
        KernelSUå†…æ ¸ - çº¢ç±³Note 10 (camellia)
        ====================================

        ä½¿ç”¨æ­¥éª¤:
        1. å¤‡ä»½åŸç‰ˆboot.img
        2. å°†boot.imgæ”¾å…¥æœ¬ç›®å½•
        3. è¿è¡Œ ./make_boot.sh
        4. åˆ·å…¥ new-boot.img
        5. å®‰è£…KernelSUç®¡ç†å™¨

        KernelSUç®¡ç†å™¨ä¸‹è½½:
        https://github.com/tiann/KernelSU/releases
        README_END

    - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-Camellia-${{ github.run_number }}
        path: |
          /home/runner/output/

    - name: ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
      run: |
        echo "# âœ… KernelSUå†…æ ¸ç¼–è¯‘æˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“± çº¢ç±³Note 10 (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- å†…æ ¸å¤§å°: $(ls -lh $HOME/output/Image.gz-dtb | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "- æ„å»ºå·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¥ ä¸‹è½½å:" >> $GITHUB_STEP_SUMMARY
        echo "1. è§£å‹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. æŸ¥çœ‹README.txt" >> $GITHUB_STEP_SUMMARY
        echo "3. ä½¿ç”¨make_boot.shåˆ¶ä½œboot.img" >> $GITHUB_STEP_SUMMARY
        echo "4. åˆ·å…¥å¹¶å®‰è£…KernelSUç®¡ç†å™¨" >> $GITHUB_STEP_SUMMARY
