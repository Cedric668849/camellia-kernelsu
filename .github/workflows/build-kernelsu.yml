name: Debug Kernel Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ¸…ç†ç©ºé—´
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        df -h

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential curl flex git libssl-dev wget \
          gcc-aarch64-linux-gnu python3 device-tree-compiler libncurses-dev \
          zip unzip

    - name: ä¸‹è½½æºç 
      run: |
        cd $HOME
        echo "ä¸‹è½½å†…æ ¸æºç ..."
        wget --no-check-certificate -q --show-progress \
          https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
          -O kernel.zip

        unzip -q kernel.zip
        mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel
        rm kernel.zip

        echo "ä¸‹è½½KernelSU..."
        wget --no-check-certificate -q --show-progress \
          https://github.com/tiann/KernelSU/archive/refs/heads/main.zip \
          -O ksu.zip

        unzip -q ksu.zip
        mv KernelSU-* KernelSU
        rm ksu.zip

    - name: æ£€æŸ¥æºç 
      run: |
        echo "===== æ£€æŸ¥å†…æ ¸æºç ç»“æž„ ====="
        ls -la $HOME/kernel/
        echo ""
        echo "===== æ£€æŸ¥arch/arm64 ====="
        ls -la $HOME/kernel/arch/arm64/ 2>/dev/null || echo "arch/arm64ä¸å­˜åœ¨"
        echo ""
        echo "===== æ£€æŸ¥Makefile ====="
        head -20 $HOME/kernel/Makefile

    - name: é›†æˆKernelSU
      run: |
        cd $HOME/kernel
        cp -r $HOME/KernelSU/kernel drivers/kernelsu
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig

        echo "KernelSUé›†æˆå®Œæˆ"
        ls -la drivers/kernelsu/

    - name: åº”ç”¨æœ€ç®€é…ç½®
      run: |
        cd $HOME/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        echo "===== ç”Ÿæˆé»˜è®¤é…ç½® ====="
        make camellia_defconfig 2>&1 | tail -50

        echo ""
        echo "===== æ£€æŸ¥é…ç½®æ–‡ä»¶ ====="
        if [ -f ".config" ]; then
          echo "é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "é…ç½®è¡Œæ•°: $(wc -l .config)"
        else
          echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶æœªç”Ÿæˆ"
        fi

        # æ·»åŠ KernelSUé…ç½®
        echo "CONFIG_KSU=y" >> .config
        make olddefconfig

    - name: å°è¯•æœ€ç®€å•ç¼–è¯‘
      run: |
        cd $HOME/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w"

        echo "===== å¼€å§‹ç¼–è¯‘prepare ====="
        make prepare 2>&1 | tail -100

        echo ""
        echo "===== å°è¯•ç¼–è¯‘scripts ====="
        make scripts 2>&1 | tail -100

        echo ""
        echo "===== å°è¯•ç¼–è¯‘vmlinux ====="
        timeout 15m make -j2 vmlinux 2>&1 | tail -200 || {
          echo "vmlinuxç¼–è¯‘è¶…æ—¶æˆ–å¤±è´¥"
        }

        echo ""
        echo "===== æŸ¥æ‰¾ä»»ä½•ç¼–è¯‘è¾“å‡º ====="
        find . -name "*.o" -type f 2>/dev/null | head -20
        find . -name "vmlinux*" -type f 2>/dev/null
        find . -name "*Image*" -type f 2>/dev/null

        echo ""
        echo "===== æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†ç¼–è¯‘æˆåŠŸ ====="
        if [ -f "vmlinux" ]; then
          echo "âœ… vmlinuxå­˜åœ¨"
          ls -lh vmlinux
        fi

        if [ -d "arch/arm64/boot" ]; then
          echo "bootç›®å½•å†…å®¹ï¼š"
          ls -la arch/arm64/boot/
        fi

    - name: å°è¯•ç»•è¿‡ç¼–è¯‘ç›´æŽ¥æ‰“åŒ…
      run: |
        mkdir -p output
        cd output

        echo "===== åˆ›å»ºå ä½å†…æ ¸æ–‡ä»¶ ====="
        # åˆ›å»ºä¸€ä¸ªå‡çš„å†…æ ¸æ–‡ä»¶ç”¨äºŽæµ‹è¯•æ‰“åŒ…æµç¨‹
        dd if=/dev/zero of=Image.gz-dtb bs=1M count=20
        echo "åˆ›å»ºäº†20MBçš„æµ‹è¯•æ–‡ä»¶"

        echo ""
        echo "===== ä¸‹è½½magiskbootï¼ˆä½¿ç”¨æ­£ç¡®é“¾æŽ¥ï¼‰====="
        # å°è¯•å¤šä¸ªä¸‹è½½æº
        echo "å°è¯•ä¸‹è½½Magisk..."

        # æ–¹æ³•1ï¼šç›´æŽ¥ä¸‹è½½APK
        wget --no-check-certificate -O Magisk.apk \
          "https://github.com/topjohnwu/Magisk/releases/download/v26.4/Magisk-26.4.apk" || {
            echo "ä¸»é“¾æŽ¥å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨..."
            # æ–¹æ³•2ï¼šä½¿ç”¨é•œåƒ
            wget --no-check-certificate -O Magisk.apk \
              "https://ghproxy.com/https://github.com/topjohnwu/Magisk/releases/download/v26.4/Magisk-26.4.apk"
          }

        if [ -f "Magisk.apk" ]; then
          echo "APKä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(ls -lh Magisk.apk | awk '{print $5}')"

          # éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„zipæ–‡ä»¶
          if unzip -t Magisk.apk > /dev/null 2>&1; then
            echo "APKæ–‡ä»¶æœ‰æ•ˆï¼Œæå–magiskboot..."
            unzip -j Magisk.apk 'lib/x86_64/libmagiskboot.so' 2>/dev/null || \
            unzip -j Magisk.apk 'lib/x86/libmagiskboot.so' 2>/dev/null || \
            unzip -j Magisk.apk '*magiskboot*' 2>/dev/null

            if [ -f "libmagiskboot.so" ]; then
              mv libmagiskboot.so magiskboot
              chmod +x magiskboot
              echo "âœ… magiskbootæå–æˆåŠŸ"
            else
              echo "âŒ æ— æ³•æå–magiskboot"
            fi
          else
            echo "APKæ–‡ä»¶æ— æ•ˆ"
          fi

          rm -f Magisk.apk
        else
          echo "âŒ æ— æ³•ä¸‹è½½Magisk"
        fi

        # åˆ›å»ºåŸºæœ¬æ–‡ä»¶
        cat > README.txt << 'EOF'
        è°ƒè¯•ç‰ˆæœ¬è¾“å‡º

        è¿™ä¸æ˜¯çœŸæ­£çš„å†…æ ¸ï¼Œåªæ˜¯æµ‹è¯•æ‰“åŒ…æµç¨‹
        è¯·æŸ¥çœ‹Actionsæ—¥å¿—äº†è§£ç¼–è¯‘å¤±è´¥åŽŸå› 
        EOF

        ls -la

    - name: åˆ†æžå¤±è´¥åŽŸå› 
      if: always()
      run: |
        echo "===== åˆ†æžç¼–è¯‘å¤±è´¥åŽŸå›  ====="

        if [ -d "$HOME/kernel" ]; then
          cd $HOME/kernel

          echo "æœ€è¿‘çš„é”™è¯¯æ—¥å¿—ï¼š"
          dmesg | tail -20 2>/dev/null || true

          echo ""
          echo "æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯ï¼š"
          find . -name "*.log" -type f 2>/dev/null | while read f; do
            echo "=== $f ==="
            tail -20 "$f" 2>/dev/null || true
          done
        fi

        echo ""
        echo "===== ç£ç›˜ç©ºé—´ ====="
        df -h

        echo ""
        echo "===== å†…å­˜ä½¿ç”¨ ====="
        free -h

    - name: ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Debug-Output
        path: output/

    - name: æ‘˜è¦
      if: always()
      run: |
        echo "# ðŸ” è°ƒè¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ç¼–è¯‘çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        if [ -f "$HOME/kernel/vmlinux" ]; then
          echo "- âœ… vmlinuxç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ vmlinuxæœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## å¯èƒ½çš„é—®é¢˜" >> $GITHUB_STEP_SUMMARY
        echo "1. å†…æ ¸æºç æœ¬èº«æœ‰ä¸¥é‡bug" >> $GITHUB_STEP_SUMMARY
        echo "2. ç¼ºå°‘å¿…è¦çš„é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "3. ç¼–è¯‘çŽ¯å¢ƒé—®é¢˜" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è¯·æŸ¥çœ‹å®Œæ•´æ—¥å¿—äº†è§£è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
