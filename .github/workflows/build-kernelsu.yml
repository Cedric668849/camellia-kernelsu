name: Build Camellia KernelSU Kernel

on:
  workflow_dispatch:
    inputs:
      kernelsu_version:
        description: 'KernelSUç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: æœ€å¤§åŒ–æž„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-docker-images: 'true'

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          git gnupg gperf liblz4-tool \
          libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python3-pip device-tree-compiler wget \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

        echo "GCCç‰ˆæœ¬:"
        aarch64-linux-gnu-gcc --version

    - name: è®¾ç½®ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "2G"

    - name: ä¸‹è½½å†…æ ¸æºç ï¼ˆä½¿ç”¨åŽ‹ç¼©åŒ…ï¼‰
      run: |
        cd $HOME
        echo "å¼€å§‹ä¸‹è½½å†…æ ¸æºç åŽ‹ç¼©åŒ…..."

        # ç›´æŽ¥ä¸‹è½½ZIPåŽ‹ç¼©åŒ…ï¼ˆæ¯”git cloneå¿«å¾ˆå¤šï¼‰
        wget -q --show-progress --timeout=300 \
          https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
          -O kernel.zip || {
            echo "GitHubä¸‹è½½å¤±è´¥ï¼Œå°è¯•åŠ é€Ÿé“¾æŽ¥..."
            # ä½¿ç”¨GitHubåŠ é€ŸæœåŠ¡
            wget -q --show-progress --timeout=300 \
              https://ghproxy.com/https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
              -O kernel.zip || {
                echo "ä½¿ç”¨é•œåƒä¸‹è½½..."
                wget -q --show-progress --timeout=300 \
                  https://mirror.ghproxy.com/https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip \
                  -O kernel.zip
              }
          }

        echo "è§£åŽ‹å†…æ ¸æºç ..."
        unzip -q kernel.zip
        mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel
        rm kernel.zip

        echo "å†…æ ¸æºç å‡†å¤‡å®Œæˆ"
        ls -la kernel/

    - name: ä¸‹è½½KernelSU
      run: |
        cd $HOME
        echo "ä¸‹è½½KernelSU..."

        if [ -n "${{ github.event.inputs.kernelsu_version }}" ]; then
          wget -q --show-progress \
            https://github.com/tiann/KernelSU/archive/refs/tags/${{ github.event.inputs.kernelsu_version }}.zip \
            -O kernelsu.zip
        else
          wget -q --show-progress \
            https://github.com/tiann/KernelSU/archive/refs/heads/main.zip \
            -O kernelsu.zip
        fi

        unzip -q kernelsu.zip
        mv KernelSU-* KernelSU
        rm kernelsu.zip

        echo "KernelSUå‡†å¤‡å®Œæˆ"

    - name: é›†æˆKernelSUåˆ°å†…æ ¸
      run: |
        cd $HOME/kernel

        # å¤åˆ¶KernelSUæ¨¡å—åˆ°å†…æ ¸
        cp -r $HOME/KernelSU/kernel drivers/kernelsu

        # éªŒè¯
        if [ -d "drivers/kernelsu" ]; then
          echo "âœ… KernelSUé›†æˆæˆåŠŸ"
          ls -la drivers/kernelsu/
        else
          echo "âŒ KernelSUé›†æˆå¤±è´¥"
          exit 1
        fi

        # ä¿®æ”¹Makefile
        if ! grep -q "kernelsu" drivers/Makefile; then
          echo 'obj-y += kernelsu/' >> drivers/Makefile
        fi

        # ä¿®æ”¹Kconfig
        if ! grep -q "kernelsu" drivers/Kconfig; then
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
        fi

        echo "KernelSUé›†æˆé…ç½®å®Œæˆ"

    - name: é…ç½®å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        # ä½¿ç”¨camelliaé»˜è®¤é…ç½®
        make camellia_defconfig

        # ç¦ç”¨ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥çš„é€‰é¡¹
        scripts/config --disable CONFIG_CC_STACKPROTECTOR_STRONG
        scripts/config --disable CONFIG_CC_STACKPROTECTOR

        # å¯ç”¨KernelSUéœ€è¦çš„é€‰é¡¹
        scripts/config --enable CONFIG_KPROBES
        scripts/config --enable CONFIG_HAVE_KPROBES
        scripts/config --enable CONFIG_KPROBE_EVENTS

        # æ·»åŠ KernelSUé…ç½®
        echo "CONFIG_KSU=y" >> .config

        # æ›´æ–°é…ç½®
        make olddefconfig

        echo "å†…æ ¸é…ç½®å®Œæˆï¼ŒéªŒè¯å…³é”®é…ç½®:"
        grep -E "CONFIG_KSU|CONFIG_KPROBES|STACKPROTECTOR" .config || true

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export KCFLAGS="-w"

        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸ (ä½¿ç”¨ $(nproc) çº¿ç¨‹)..."
        echo "é¢„è®¡éœ€è¦15-20åˆ†é’Ÿ..."

        # ç¼–è¯‘å†…æ ¸é•œåƒ
        make -j$(nproc) Image.gz-dtb 2>&1 | tail -n 100

        # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ!"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
          echo "æŸ¥çœ‹æœ€åŽçš„é”™è¯¯ä¿¡æ¯..."
          exit 1
        fi

    - name: æ‰“åŒ…ç¼–è¯‘äº§ç‰©
      run: |
        mkdir -p $HOME/output

        # å¤åˆ¶å†…æ ¸
        cp $HOME/kernel/arch/arm64/boot/Image.gz-dtb $HOME/output/

        # ä¸‹è½½boot.imgå¤„ç†å·¥å…·
        cd $HOME/output
        echo "ä¸‹è½½boot.imgå¤„ç†å·¥å…·..."
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk
        unzip -q -j Magisk-26.4.apk 'lib/x86_64/libmagiskboot.so'
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
        rm Magisk-26.4.apk

        # åˆ›å»ºWindowsæ‰¹å¤„ç†è„šæœ¬
        cat > make_boot.bat << 'BAT_END'
        @echo off
        echo KernelSU Boot.img åˆ¶ä½œå·¥å…· (Windows)
        echo =====================================
        echo.

        if not exist boot.img (
          echo é”™è¯¯: è¯·å…ˆå°†åŽŸç‰ˆboot.imgæ”¾åˆ°æœ¬ç›®å½•
          pause
          exit /b 1
        )

        echo [1/3] è§£åŒ…boot.img...
        magiskboot.exe unpack boot.img

        echo [2/3] æ›¿æ¢ä¸ºKernelSUå†…æ ¸...
        copy /Y Image.gz-dtb kernel

        echo [3/3] é‡æ–°æ‰“åŒ…...
        magiskboot.exe repack boot.img

        echo.
        echo å®Œæˆ! ç”Ÿæˆæ–‡ä»¶: new-boot.img
        echo.
        echo åˆ·å…¥æ–¹æ³•:
        echo   adb reboot bootloader
        echo   fastboot flash boot new-boot.img
        echo   fastboot reboot
        echo.
        pause
        BAT_END

        # åˆ›å»ºLinux/Macè„šæœ¬
        cat > make_boot.sh << 'SH_END'
        #!/bin/bash
        echo "KernelSU Boot.img åˆ¶ä½œå·¥å…· (Linux/Mac)"
        echo "======================================"
        echo ""

        if [ ! -f boot.img ]; then
          echo "é”™è¯¯: è¯·å…ˆå°†åŽŸç‰ˆboot.imgæ”¾åˆ°æœ¬ç›®å½•"
          exit 1
        fi

        echo "[1/3] è§£åŒ…boot.img..."
        ./magiskboot unpack boot.img

        echo "[2/3] æ›¿æ¢ä¸ºKernelSUå†…æ ¸..."
        cp Image.gz-dtb kernel

        echo "[3/3] é‡æ–°æ‰“åŒ…..."
        ./magiskboot repack boot.img

        echo ""
        echo "å®Œæˆ! ç”Ÿæˆæ–‡ä»¶: new-boot.img"
        echo ""
        echo "åˆ·å…¥æ–¹æ³•:"
        echo "  adb reboot bootloader"
        echo "  fastboot flash boot new-boot.img"
        echo "  fastboot reboot"
        SH_END
        chmod +x make_boot.sh

        # åˆ›å»ºè¯´æ˜Žæ–‡æ¡£
        cat > ä½¿ç”¨è¯´æ˜Ž.txt << 'DOC_END'
        KernelSUå†…æ ¸ for çº¢ç±³Note 10 (camellia)
        ========================================

        ã€æ–‡ä»¶è¯´æ˜Žã€‘
        - Image.gz-dtb    : KernelSUå†…æ ¸æ–‡ä»¶
        - magiskboot      : Booté•œåƒå¤„ç†å·¥å…·
        - make_boot.sh    : Linux/Macåˆ¶ä½œè„šæœ¬
        - make_boot.bat   : Windowsåˆ¶ä½œè„šæœ¬

        ã€ä½¿ç”¨æ­¥éª¤ã€‘

        1. æå–æ‰‹æœºçš„åŽŸç‰ˆboot.img:
           adb shell su -c "dd if=/dev/block/by-name/boot of=/sdcard/boot.img"
           adb pull /sdcard/boot.img

        2. å°†boot.imgæ”¾åˆ°æœ¬ç›®å½•

        3. è¿è¡Œåˆ¶ä½œè„šæœ¬:
           - Windows: åŒå‡» make_boot.bat
           - Linux/Mac: è¿è¡Œ ./make_boot.sh

        4. åˆ·å…¥new-boot.img:
           adb reboot bootloader
           fastboot flash boot new-boot.img
           fastboot reboot

        5. å®‰è£…KernelSUç®¡ç†å™¨:
           https://github.com/tiann/KernelSU/releases

        ã€æ³¨æ„äº‹é¡¹ã€‘
        âš ï¸ åˆ·å…¥å‰å¿…é¡»å¤‡ä»½åŽŸç‰ˆboot.img
        âš ï¸ éœ€è¦è§£é”Bootloader
        âš ï¸ KernelSUå°†æ›¿ä»£åŽŸæœ‰çš„Magisk/Kitsune Mask
        âš ï¸ é¦–æ¬¡åˆ·å…¥å»ºè®®æ¸…é™¤æ•°æ®

        ã€æ•‘ç –æ–¹æ³•ã€‘
        å¦‚æžœæ— æ³•å¼€æœºï¼Œè¿›å…¥fastbootæ¨¡å¼åˆ·å›žåŽŸç‰ˆ:
        fastboot flash boot boot_backup.img
        DOC_END

    - name: ä¸Šä¼ ç¼–è¯‘ç»“æžœ
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-Camellia-${{ github.run_number }}
        path: |
          /home/runner/output/

    - name: ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
      run: |
        echo "# âœ… KernelSUå†…æ ¸ç¼–è¯‘æˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“± è®¾å¤‡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **åž‹å·**: çº¢ç±³Note 10 (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤„ç†å™¨**: MediaTek Dimensity 700" >> $GITHUB_STEP_SUMMARY
        echo "- **Android**: 11 (R)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ ç¼–è¯‘ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **å†…æ ¸å¤§å°**: $(ls -lh $HOME/output/Image.gz-dtb | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç¼–å·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ ä¸‹è½½è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸Šæ–¹ **KernelSU-Camellia-${{ github.run_number }}** ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "2. è§£åŽ‹åŽæŸ¥çœ‹ã€Šä½¿ç”¨è¯´æ˜Ž.txtã€‹" >> $GITHUB_STEP_SUMMARY
        echo "3. ä½¿ç”¨æä¾›çš„è„šæœ¬åˆ¶ä½œboot.img" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš ï¸ é‡è¦æé†’" >> $GITHUB_STEP_SUMMARY
        echo "- è¿™æ˜¯KernelSUå†…æ ¸ï¼Œä¸æ˜¯Magisk" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ·å…¥å‰åŠ¡å¿…å¤‡ä»½åŽŸç‰ˆboot.img" >> $GITHUB_STEP_SUMMARY
        echo "- éœ€è¦å®‰è£…KernelSUç®¡ç†å™¨APP" >> $GITHUB_STEP_SUMMARY
