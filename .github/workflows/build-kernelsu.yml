name: Build Camellia KernelSU Kernel

on:
  workflow_dispatch:
    inputs:
      kernelsu_version:
        description: 'KernelSUç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æœ€å¤§åŒ–æž„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update

        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          git gnupg gperf liblz4-tool \
          libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python3-pip device-tree-compiler wget

        # å®‰è£…ARM64äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

        # éªŒè¯GCCç‰ˆæœ¬
        aarch64-linux-gnu-gcc --version

    - name: è®¾ç½®ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "2G"

    - name: è®¾ç½®å·¥ä½œç›®å½•
      run: |
        mkdir -p $HOME/kernel_build
        echo "KERNEL_DIR=$HOME/kernel_build" >> $GITHUB_ENV

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        cd $HOME/kernel_build
        git clone https://github.com/MiCode/Xiaomi_Kernel_OpenSource.git -b camellia-r-oss kernel --depth=1
        echo "å†…æ ¸æºç å…‹éš†å®Œæˆ"
        ls -la kernel/

    - name: å…‹éš†KernelSU
      run: |
        cd $HOME/kernel_build
        if [ -n "${{ github.event.inputs.kernelsu_version }}" ]; then
          git clone https://github.com/tiann/KernelSU.git -b ${{ github.event.inputs.kernelsu_version }} --depth=1
        else
          git clone https://github.com/tiann/KernelSU.git --depth=1
        fi
        cd KernelSU
        echo "KernelSUç‰ˆæœ¬: $(git describe --tags --always)"
        cd ..
        echo "æ£€æŸ¥KernelSUå†…æ ¸æ¨¡å—:"
        ls -la KernelSU/kernel/

    - name: é›†æˆKernelSUåˆ°å†…æ ¸
      run: |
        cd $HOME/kernel_build/kernel

        # ç›´æŽ¥å¤åˆ¶KernelSUåˆ°driversç›®å½•ï¼ˆé¿å…ç¬¦å·é“¾æŽ¥æƒé™é—®é¢˜ï¼‰
        cp -r ../KernelSU/kernel drivers/kernelsu

        # éªŒè¯å¤åˆ¶æˆåŠŸ
        if [ -d "drivers/kernelsu" ]; then
          echo "KernelSUå¤åˆ¶æˆåŠŸ"
          ls -la drivers/kernelsu/
        else
          echo "é”™è¯¯ï¼šKernelSUå¤åˆ¶å¤±è´¥"
          exit 1
        fi

        # ä¿®æ”¹Makefile
        if ! grep -q "kernelsu" drivers/Makefile; then
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          echo "å·²æ·»åŠ kernelsuåˆ°Makefile"
        fi

        # ä¿®æ”¹Kconfig
        if ! grep -q "kernelsu" drivers/Kconfig; then
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo "å·²æ·»åŠ kernelsuåˆ°Kconfig"
        fi

        echo "KernelSUé›†æˆå®Œæˆ"

    - name: é…ç½®å†…æ ¸
      run: |
        cd $HOME/kernel_build/kernel

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

        # ç¦ç”¨æ ˆä¿æŠ¤ï¼ˆè§£å†³ç¼–è¯‘å™¨ä¸æ”¯æŒçš„é—®é¢˜ï¼‰
        export KCFLAGS="-w"
        export CONFIG_CC_STACKPROTECTOR_STRONG=n

        # ä½¿ç”¨é»˜è®¤é…ç½®
        make camellia_defconfig

        # ä¿®æ”¹é…ç½®ï¼šç¦ç”¨æ ˆä¿æŠ¤ï¼Œå¯ç”¨KernelSU
        scripts/config --disable CONFIG_CC_STACKPROTECTOR_STRONG
        scripts/config --disable CONFIG_CC_STACKPROTECTOR
        scripts/config --enable CONFIG_KPROBES
        scripts/config --enable CONFIG_HAVE_KPROBES
        scripts/config --enable CONFIG_KPROBE_EVENTS

        # æ‰‹åŠ¨æ·»åŠ KernelSUé…ç½®ï¼ˆå¦‚æžœconfigå·¥å…·ä¸è¯†åˆ«ï¼‰
        echo "CONFIG_KSU=y" >> .config

        # æ›´æ–°é…ç½®
        make olddefconfig

        echo "éªŒè¯é…ç½®:"
        grep -E "STACKPROTECTOR|KSU|KPROBES" .config

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd $HOME/kernel_build/kernel

        # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export USE_CCACHE=1
        export CCACHE_DIR=$HOME/.ccache

        # ç¦ç”¨æ ˆä¿æŠ¤
        export KCFLAGS="-w"
        export CONFIG_CC_STACKPROTECTOR_STRONG=n

        # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘ï¼ˆå¦‚æžœæœ‰ï¼‰
        make clean

        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨$(nproc)ä¸ªçº¿ç¨‹ï¼‰..."
        make -j$(nproc) Image.gz-dtb 2>&1 | tee build.log || {
          echo "ç¼–è¯‘å¤±è´¥ï¼Œæ˜¾ç¤ºæœ€åŽ100è¡Œæ—¥å¿—:"
          tail -n 100 build.log
          exit 1
        }

        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶:"
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡ºæ–‡ä»¶"
          exit 1
        fi

    - name: å‡†å¤‡æ‰“åŒ…å·¥å…·
      run: |
        cd ${{ github.workspace }}

        # ä¸‹è½½magiskboot
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk
        unzip -j Magisk-*.apk 'lib/x86_64/libmagiskboot.so' -d .
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
        rm Magisk-*.apk

        # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
        cat > README.md << 'END_README'
        # KernelSUå†…æ ¸ä½¿ç”¨è¯´æ˜Ž

        ## å…³äºŽKernelSU
        KernelSUæ˜¯å†…æ ¸çº§çš„rootæ–¹æ¡ˆï¼Œä¸ŽMagiskï¼ˆKitsune Maskï¼‰çš„å…³ç³»ï¼š
        - KernelSUå’ŒMagiskæ˜¯ä¸¤ç§ä¸åŒçš„rootæ–¹æ¡ˆ
        - åˆ·å…¥KernelSUåŽï¼Œä¸å†éœ€è¦Magisk/Kitsune Mask
        - KernelSUæœ‰è‡ªå·±çš„ç®¡ç†å™¨APPå’Œæ¨¡å—ç³»ç»Ÿ
        - åŽŸMagiskæ¨¡å—éœ€è¦è½¬æ¢æ‰èƒ½åœ¨KernelSUä½¿ç”¨

        ## åˆ·å…¥æ­¥éª¤

        1. æå–åŽŸå§‹boot.img:
           ```
           adb shell su -c 'dd if=/dev/block/by-name/boot of=/sdcard/boot.img'
           adb pull /sdcard/boot.img
           ```

        2. åˆ¶ä½œæ–°boot.img:
           ```
           ./magiskboot unpack boot.img
           cp Image.gz-dtb kernel
           ./magiskboot repack boot.img
           ```

        3. åˆ·å…¥æ–°å†…æ ¸:
           ```
           adb reboot bootloader
           fastboot flash boot new-boot.img
           fastboot reboot
           ```

        4. å®‰è£…KernelSUç®¡ç†å™¨:
           - ä¸‹è½½åœ°å€: https://github.com/tiann/KernelSU/releases
           - å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„KernelSU.apk

        ## é‡è¦æé†’
        - åˆ·å…¥å‰åŠ¡å¿…å¤‡ä»½åŽŸå§‹boot.img
        - é¦–æ¬¡ä½¿ç”¨éœ€è¦åœ¨KernelSUç®¡ç†å™¨ä¸­æŽˆäºˆåº”ç”¨rootæƒé™
        - åŽŸMagiskæ¨¡å—ä¸èƒ½ç›´æŽ¥ä½¿ç”¨ï¼Œéœ€è¦é€‚é…
        END_README

    - name: æ”¶é›†ç¼–è¯‘äº§ç‰©
      run: |
        mkdir -p output
        cp $HOME/kernel_build/kernel/arch/arm64/boot/Image.gz-dtb output/
        cp magiskboot output/
        cp README.md output/

        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        cat > output/version.txt << END_VERSION
        ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        è®¾å¤‡: çº¢ç±³Note 10 (camellia)
        å†…æ ¸æºç : camellia-r-oss
        KernelSUç‰ˆæœ¬: $(cd $HOME/kernel_build/KernelSU && git describe --tags --always)
        ç¼–è¯‘å™¨: $(aarch64-linux-gnu-gcc --version | head -n1)
        END_VERSION

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernelsu-camellia-kernel
        path: output/

    - name: æ˜¾ç¤ºç¼–è¯‘æ‘˜è¦
      run: |
        echo "## âœ… ç¼–è¯‘æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± è®¾å¤‡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- è®¾å¤‡: çº¢ç±³Note 10 (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- å¤„ç†å™¨: MediaTek Dimensity 700" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ KernelSU vs Magisk" >> $GITHUB_STEP_SUMMARY
        echo "- KernelSUæ˜¯ç‹¬ç«‹çš„rootæ–¹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸éœ€è¦Magisk/Kitsune Mask" >> $GITHUB_STEP_SUMMARY
        echo "- æœ‰ä¸“é—¨çš„KernelSUç®¡ç†å™¨APP" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ä¸‹è½½å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "- Image.gz-dtb: ç¼–è¯‘çš„å†…æ ¸" >> $GITHUB_STEP_SUMMARY
        echo "- magiskboot: æ‰“åŒ…å·¥å…·" >> $GITHUB_STEP_SUMMARY
        echo "- README.md: ä½¿ç”¨è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ æ³¨æ„äº‹é¡¹" >> $GITHUB_STEP_SUMMARY
        echo "1. å¤‡ä»½åŽŸå§‹boot.img" >> $GITHUB_STEP_SUMMARY
        echo "2. å®‰è£…KernelSUç®¡ç†å™¨APP" >> $GITHUB_STEP_SUMMARY
        echo "3. åŽŸMagiskæ¨¡å—éœ€è¦è½¬æ¢" >> $GITHUB_STEP_SUMMARY
