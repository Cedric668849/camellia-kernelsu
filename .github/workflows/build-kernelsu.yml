name: Build Camellia KernelSU Kernel

on:
  workflow_dispatch:
    inputs:
      kernelsu_version:
        description: 'KernelSUç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: æœ€å¤§åŒ–æž„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-docker-images: 'true'

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          git gnupg gperf liblz4-tool \
          libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python3-pip device-tree-compiler wget \
          gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

        # éªŒè¯GCC
        aarch64-linux-gnu-gcc --version

    - name: è®¾ç½®ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "2G"

    - name: å…‹éš†å†…æ ¸æºç ï¼ˆä½¿ç”¨æµ…å…‹éš†ï¼‰
      run: |
        cd $HOME
        echo "å¼€å§‹å…‹éš†å†…æ ¸æºç ï¼ˆæµ…å…‹éš†ä»¥åŠ é€Ÿï¼‰..."

        # è®¾ç½®gité…ç½®ä»¥æé«˜é€Ÿåº¦
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global core.compression 0

        # ä½¿ç”¨æžæµ…å…‹éš†ï¼ˆåªå…‹éš†æœ€æ–°æäº¤ï¼‰
        timeout 10m git clone \
          --depth=1 \
          --single-branch \
          --branch camellia-r-oss \
          --no-tags \
          https://github.com/MiCode/Xiaomi_Kernel_OpenSource.git kernel || {
            echo "GitHubå…‹éš†å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é•œåƒ..."

            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨Giteeé•œåƒï¼ˆå¦‚æžœæœ‰ï¼‰
            git clone \
              --depth=1 \
              --single-branch \
              --branch camellia-r-oss \
              https://gitee.com/MiCode/Xiaomi_Kernel_OpenSource.git kernel || {

                # æœ€åŽæ–¹æ¡ˆï¼šä¸‹è½½åŽ‹ç¼©åŒ…
                echo "å…‹éš†å¤±è´¥ï¼Œå°è¯•ä¸‹è½½åŽ‹ç¼©åŒ…..."
                wget -q --show-progress \
                  https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip
                unzip -q camellia-r-oss.zip
                mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel
              }
          }

        echo "å†…æ ¸æºç èŽ·å–å®Œæˆ"
        ls -la kernel/

    - name: å…‹éš†KernelSU
      run: |
        cd $HOME
        if [ -n "${{ github.event.inputs.kernelsu_version }}" ]; then
          git clone --depth=1 https://github.com/tiann/KernelSU.git -b ${{ github.event.inputs.kernelsu_version }}
        else
          git clone --depth=1 https://github.com/tiann/KernelSU.git
        fi
        cd KernelSU
        echo "KernelSUç‰ˆæœ¬: $(git describe --tags --always || echo 'latest')"

    - name: é›†æˆKernelSU
      run: |
        cd $HOME/kernel

        # å¤åˆ¶KernelSU
        cp -r $HOME/KernelSU/kernel drivers/kernelsu

        # éªŒè¯
        if [ -d "drivers/kernelsu" ]; then
          echo "âœ… KernelSUé›†æˆæˆåŠŸ"
        else
          echo "âŒ KernelSUé›†æˆå¤±è´¥"
          exit 1
        fi

        # ä¿®æ”¹Makefileå’ŒKconfig
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig

    - name: é…ç½®å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        # ä½¿ç”¨è®¾å¤‡é…ç½®
        make camellia_defconfig

        # ç¦ç”¨æ ˆä¿æŠ¤
        scripts/config --disable CONFIG_CC_STACKPROTECTOR_STRONG
        scripts/config --disable CONFIG_CC_STACKPROTECTOR

        # å¯ç”¨KernelSU
        scripts/config --enable CONFIG_KPROBES
        scripts/config --enable CONFIG_HAVE_KPROBES
        scripts/config --enable CONFIG_KPROBE_EVENTS
        echo "CONFIG_KSU=y" >> .config

        # æ›´æ–°é…ç½®
        make olddefconfig

        # éªŒè¯
        echo "é…ç½®æ£€æŸ¥:"
        grep -E "STACKPROTECTOR|KSU|KPROBES" .config || true

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd $HOME/kernel

        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export KCFLAGS="-w"
        export CONFIG_CC_STACKPROTECTOR_STRONG=n

        # ç¼–è¯‘
        echo "å¼€å§‹ç¼–è¯‘ (ä½¿ç”¨ $(nproc) çº¿ç¨‹)..."
        make -j$(nproc) Image.gz-dtb 2>&1 | tail -n 200

        # æ£€æŸ¥è¾“å‡º
        if [ -f arch/arm64/boot/Image.gz-dtb ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    - name: å‡†å¤‡äº§ç‰©
      run: |
        mkdir -p output

        # å¤åˆ¶å†…æ ¸
        cp $HOME/kernel/arch/arm64/boot/Image.gz-dtb output/

        # ä¸‹è½½magiskbootï¼ˆåªæ˜¯æ‰“åŒ…å·¥å…·ï¼Œä¸æ˜¯Magiskï¼‰
        echo "ä¸‹è½½boot.imgæ‰“åŒ…å·¥å…·..."
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk
        unzip -q -j Magisk-*.apk 'lib/x86_64/libmagiskboot.so' -d output/
        mv output/libmagiskboot.so output/magiskboot
        chmod +x output/magiskboot
        rm Magisk-*.apk

        # åˆ›å»ºåˆ·å…¥è„šæœ¬
        cat > output/flash.sh << 'FLASH_SCRIPT'
        #!/bin/bash
        echo "KernelSUå†…æ ¸åˆ·å…¥å·¥å…·"
        echo "===================="
        echo "æ³¨æ„ï¼šè¿™æ˜¯KernelSUå†…æ ¸ï¼Œä¸æ˜¯Magiskï¼"
        echo ""

        if [ ! -f "boot.img" ]; then
          echo "é”™è¯¯: è¯·å…ˆæ”¾å…¥åŽŸç‰ˆboot.img"
          exit 1
        fi

        echo "1. è§£åŒ…boot.img..."
        ./magiskboot unpack boot.img

        echo "2. æ›¿æ¢ä¸ºKernelSUå†…æ ¸..."
        cp Image.gz-dtb kernel

        echo "3. é‡æ–°æ‰“åŒ…..."
        ./magiskboot repack boot.img

        echo "4. å®Œæˆï¼"
        echo "   ç”Ÿæˆæ–‡ä»¶: new-boot.img (åŒ…å«KernelSU)"
        echo ""
        echo "åˆ·å…¥å‘½ä»¤:"
        echo "  adb reboot bootloader"
        echo "  fastboot flash boot new-boot.img"
        echo "  fastboot reboot"
        echo ""
        echo "åˆ·å…¥åŽè¯·å®‰è£…KernelSUç®¡ç†å™¨APP"
        echo "ä¸‹è½½åœ°å€: https://github.com/tiann/KernelSU/releases"
        FLASH_SCRIPT

        chmod +x output/flash.sh

        # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
        cat > output/README.txt << 'README'
        KernelSUå†…æ ¸ - çº¢ç±³Note 10 (camellia)
        =====================================

        ã€é‡è¦è¯´æ˜Žã€‘
        è¿™æ˜¯KernelSUå†…æ ¸ï¼Œä¸æ˜¯Magisk/Kitsune Maskï¼
        magiskbootåªæ˜¯ç”¨æ¥æ‰“åŒ…boot.imgçš„å·¥å…·ã€‚

        ã€åŒ…å«æ–‡ä»¶ã€‘
        - Image.gz-dtb: ç¼–è¯‘çš„KernelSUå†…æ ¸
        - magiskboot: boot.imgæ‰“åŒ…å·¥å…·ï¼ˆä¸å«Magiskï¼‰
        - flash.sh: è‡ªåŠ¨åˆ·å…¥è„šæœ¬

        ã€ä½¿ç”¨æ­¥éª¤ã€‘
        1. å¤‡ä»½åŽŸç‰ˆboot.img
           adb shell su -c 'dd if=/dev/block/by-name/boot of=/sdcard/boot_backup.img'
           adb pull /sdcard/boot_backup.img

        2. å°†boot_backup.imgå¤åˆ¶åˆ°æœ¬ç›®å½•å¹¶æ”¹åä¸ºboot.img

        3. Linux/Macè¿è¡Œï¼š
           ./flash.sh

           Windowsæ‰‹åŠ¨æ‰§è¡Œï¼š
           magiskboot.exe unpack boot.img
           copy Image.gz-dtb kernel
           magiskboot.exe repack boot.img

        4. åˆ·å…¥new-boot.imgï¼š
           adb reboot bootloader
           fastboot flash boot new-boot.img
           fastboot reboot

        5. å®‰è£…KernelSUç®¡ç†å™¨APP
           ä¸‹è½½: https://github.com/tiann/KernelSU/releases

        ã€æ³¨æ„äº‹é¡¹ã€‘
        - å¿…é¡»å…ˆå¤‡ä»½åŽŸç‰ˆboot.imgï¼
        - éœ€è¦è§£é”Bootloader
        - KernelSUä¼šæ›¿ä»£Magisk/Kitsune Mask
        - åŽŸMagiskæ¨¡å—éœ€è¦è½¬æ¢æ‰èƒ½ä½¿ç”¨
        README

        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        cat > output/version.txt << VERSION
        ç¼–è¯‘ä¿¡æ¯
        ========
        ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        è®¾å¤‡åž‹å·: çº¢ç±³Note 10 (camellia)
        å¤„ç†å™¨: MediaTek Dimensity 700
        Android: 11 (R)
        å†…æ ¸æºç : camellia-r-oss
        KernelSUç‰ˆæœ¬: $(cd $HOME/KernelSU && git describe --tags --always || echo 'latest')
        ç¼–è¯‘å™¨: $(aarch64-linux-gnu-gcc --version | head -n1)

        è¿™æ˜¯KernelSUå†…æ ¸ï¼Œä¸åŒ…å«Magiskï¼
        VERSION

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-Camellia
        path: output/

    - name: æ˜¾ç¤ºæ‘˜è¦
      run: |
        echo "## âœ… ç¼–è¯‘æˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± è®¾å¤‡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- åž‹å·: çº¢ç±³Note 10 (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- å¤„ç†å™¨: MediaTek Dimensity 700" >> $GITHUB_STEP_SUMMARY
        echo "- å†…æ ¸å¤§å°: $(ls -lh output/Image.gz-dtb | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ é‡è¦è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "- è¿™æ˜¯**KernelSUå†…æ ¸**ï¼Œä¸æ˜¯Magisk" >> $GITHUB_STEP_SUMMARY
        echo "- magiskbootåªæ˜¯æ‰“åŒ…å·¥å…·" >> $GITHUB_STEP_SUMMARY
        echo "- åˆ·å…¥åŽéœ€å®‰è£…KernelSUç®¡ç†å™¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½KernelSU-Camellia.zip" >> $GITHUB_STEP_SUMMARY
        echo "2. å¤‡ä»½åŽŸç‰ˆboot.img" >> $GITHUB_STEP_SUMMARY
        echo "3. è¿è¡Œflash.shç”Ÿæˆnew-boot.img" >> $GITHUB_STEP_SUMMARY
        echo "4. åˆ·å…¥å¹¶å®‰è£…KernelSUç®¡ç†å™¨" >> $GITHUB_STEP_SUMMARY
