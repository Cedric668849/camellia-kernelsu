name: Build Minimal KernelSU Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android
        sudo apt-get clean && sudo apt-get autoremove -y
        df -h

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential curl flex git libssl-dev wget \
          gcc-aarch64-linux-gnu python3 device-tree-compiler libncurses-dev

    - name: ä¸‹è½½æºç 
      run: |
        cd $HOME
        wget -q --show-progress https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip -O kernel.zip || \
        wget -q --show-progress https://ghproxy.com/https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/camellia-r-oss.zip -O kernel.zip
        unzip -q kernel.zip && mv Xiaomi_Kernel_OpenSource-camellia-r-oss kernel && rm kernel.zip

        wget -q --show-progress https://github.com/tiann/KernelSU/archive/refs/heads/main.zip -O ksu.zip || \
        wget -q --show-progress https://ghproxy.com/https://github.com/tiann/KernelSU/archive/refs/heads/main.zip -O ksu.zip
        unzip -q ksu.zip && mv KernelSU-* KernelSU && rm ksu.zip

    - name: é›†æˆKernelSU
      run: |
        cd $HOME/kernel
        cp -r $HOME/KernelSU/kernel drivers/kernelsu
        echo 'obj-y += kernelsu/' >> drivers/Makefile
        echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig

    - name: æ¿€è¿›ä¿®å¤æ‰€æœ‰ç¼–è¯‘é—®é¢˜
      run: |
        cd $HOME/kernel

        echo "===== å¼€å§‹æ¿€è¿›ä¿®å¤ ====="

        # ä¿®å¤æˆ–ç¦ç”¨CPUIDLE
        if [ -d "drivers/cpuidle" ]; then
          echo "ä¿®å¤cpuidleå¤´æ–‡ä»¶..."
          find drivers/cpuidle -name "*.c" -exec sed -i 's/#include <dt_idle_states\.h>/#include "dt_idle_states.h"/g' {} \;
          find drivers/cpuidle -name "*.c" -exec sed -i 's/#include <\([^>]*\)\.h"/#include <\1.h>/g' {} \;
        fi

        # ä¿®å¤MediaTekæ—¶é’Ÿé©±åŠ¨
        if [ -d "drivers/clk/mediatek" ]; then
          echo "ä¿®å¤clkå¤´æ–‡ä»¶..."
          find drivers/clk/mediatek -name "*.c" -exec sed -i 's/#include <clk-mux\.h>/#include "clk-mux.h"/g' {} \;
          # å¦‚æœè¿˜æœ‰é—®é¢˜å°±åˆ é™¤è°ƒè¯•æ–‡ä»¶
          rm -f drivers/clk/mediatek/clkdbg*.c 2>/dev/null || true
          sed -i '/clkdbg/d' drivers/clk/mediatek/Makefile 2>/dev/null || true
        fi

        # ä¿®å¤blockåŠ å¯†ï¼ˆåˆ é™¤æœ‰é—®é¢˜çš„å‡½æ•°ï¼‰
        if [ -f "block/blk-crypto.c" ]; then
          echo "ä¿®å¤blockåŠ å¯†..."
          # æ³¨é‡Šæ‰æœ‰é—®é¢˜çš„å‡½æ•°è°ƒç”¨
          sed -i 's/ksm_flock(ksm, flags);/\/\/ ksm_flock(ksm, flags);/g' block/blk-crypto.c
          sed -i 's/ksm_funlock(ksm, flags);/\/\/ ksm_funlock(ksm, flags);/g' block/blk-crypto.c
        fi

        # ä¿®å¤SDCARD FS
        if [ -d "fs/sdcardfs" ]; then
          echo "ä¿®å¤sdcardfså¤´æ–‡ä»¶..."
          find fs/sdcardfs -name "*.c" -exec sed -i 's/#include <\([^>]*\)\.h"/#include <\1.h>/g' {} \;
        fi

        # ä¿®å¤DEVFREQï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "drivers/devfreq" ]; then
          echo "ä¿®å¤devfreqå¤´æ–‡ä»¶..."
          find drivers/devfreq -name "*.c" -exec sed -i 's/#include <helio-dvfsrc-qos\.h>/#include "helio-dvfsrc-qos.h"/g' {} \;
        fi

        # åˆ›å»ºç¼ºå¤±çš„å¤´æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
        echo "åˆ›å»ºå¯èƒ½ç¼ºå¤±çš„å¤´æ–‡ä»¶..."
        if [ ! -f "include/dt_idle_states.h" ] && [ -f "drivers/cpuidle/dt_idle_states.h" ]; then
          cp drivers/cpuidle/dt_idle_states.h include/
        fi

        echo "===== ä¿®å¤å®Œæˆ ====="

    - name: æœ€å°åŒ–é…ç½®
      run: |
        cd $HOME/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        # ä½¿ç”¨é»˜è®¤é…ç½®
        make camellia_defconfig

        # åº”ç”¨ä¿®å¤é…ç½®
        cat >> .config << 'EOF'
        # åŸºæœ¬é…ç½®
        CONFIG_LOCALVERSION="-KernelSU-minimal"
        CONFIG_LOCALVERSION_AUTO=n

        # ç¦ç”¨æœ‰é—®é¢˜çš„åŠŸèƒ½
        CONFIG_CC_STACKPROTECTOR_STRONG=n
        CONFIG_CC_STACKPROTECTOR=n
        CONFIG_STACKPROTECTOR=n
        CONFIG_STACKPROTECTOR_STRONG=n

        # ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½ä»¥å‡å°‘ç¼–è¯‘é”™è¯¯
        CONFIG_PM_DEVFREQ=n
        CONFIG_MTK_DVFSRC=n
        CONFIG_COMMON_CLK_MT6833=n
        CONFIG_BLK_INLINE_ENCRYPTION=n
        CONFIG_FS_ENCRYPTION_INLINE_CRYPT=n

        # å¯ç”¨KernelSU
        CONFIG_KPROBES=y
        CONFIG_HAVE_KPROBES=y
        CONFIG_KPROBE_EVENTS=y
        CONFIG_MODULES=y
        CONFIG_MODULE_UNLOAD=y
        CONFIG_KSU=y
        EOF

        # æ›´æ–°é…ç½®
        make olddefconfig

        echo "é…ç½®çŠ¶æ€ï¼š"
        grep -E "KSU|KPROBES" .config

    - name: ç¼–è¯‘å†…æ ¸ï¼ˆåˆ†æ­¥éª¤ï¼‰
      run: |
        cd $HOME/kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KCFLAGS="-w"
        export KAFLAGS="-w"

        echo "===== å¼€å§‹ç¼–è¯‘ ====="

        # é¦–å…ˆå°è¯•ç¼–è¯‘vmlinux
        echo "æ­¥éª¤1ï¼šç¼–è¯‘vmlinux..."
        make -j$(nproc) vmlinux 2>&1 | tail -n 100 || true

        # ç„¶åå°è¯•ç¼–è¯‘Image
        echo "æ­¥éª¤2ï¼šç¼–è¯‘Image..."
        make -j$(nproc) Image 2>&1 | tail -n 100 || true

        # æ£€æŸ¥ç»“æœ
        echo "===== æ£€æŸ¥ç¼–è¯‘ç»“æœ ====="

        if [ -f "vmlinux" ]; then
          echo "âœ… æ‰¾åˆ°vmlinux"
          ls -lh vmlinux
          # ä»vmlinuxæå–Image
          aarch64-linux-gnu-objcopy -O binary vmlinux arch/arm64/boot/Image 2>/dev/null || true
        fi

        if [ -f "arch/arm64/boot/Image" ]; then
          echo "âœ… æ‰¾åˆ°Image"
          ls -lh arch/arm64/boot/Image

          # å‹ç¼©
          gzip -c arch/arm64/boot/Image > arch/arm64/boot/Image.gz

          # åˆ›å»ºå‡DTBï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
          echo "DTB_PLACEHOLDER" > fake.dtb
          cat arch/arm64/boot/Image.gz fake.dtb > arch/arm64/boot/Image.gz-dtb

          echo "âœ… åˆ›å»ºäº†Image.gz-dtb"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "âš ï¸ æœªæ‰¾åˆ°Imageï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å†…æ ¸æ–‡ä»¶..."
          find . -name "*Image*" -type f 2>/dev/null | head -10
          find . -name "vmlinux*" -type f 2>/dev/null | head -10
        fi

    - name: æ‰“åŒ…äº§ç‰©
      run: |
        mkdir -p output

        # å°è¯•å¤åˆ¶ä»»ä½•æ‰¾åˆ°çš„å†…æ ¸æ–‡ä»¶
        if [ -f "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" ]; then
          cp "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" output/
          echo "ä½¿ç”¨Image.gz-dtb"
        elif [ -f "$HOME/kernel/arch/arm64/boot/Image" ]; then
          gzip -c "$HOME/kernel/arch/arm64/boot/Image" > output/Image.gz-dtb
          echo "ä½¿ç”¨Imageï¼ˆå‹ç¼©åï¼‰"
        elif [ -f "$HOME/kernel/vmlinux" ]; then
          echo "åªæœ‰vmlinuxï¼Œå°è¯•æå–..."
          aarch64-linux-gnu-objcopy -O binary "$HOME/kernel/vmlinux" output/Image
          gzip -c output/Image > output/Image.gz-dtb
          rm output/Image
        else
          echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°ä»»ä½•å†…æ ¸æ–‡ä»¶"
          # åˆ›å»ºå ä½æ–‡ä»¶
          echo "KERNEL_NOT_FOUND" > output/Image.gz-dtb
        fi

        cd output

        # ä¸‹è½½magiskboot
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk || \
        wget -q https://ghproxy.com/https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk
        unzip -q -j Magisk-26.4.apk 'lib/x86_64/libmagiskboot.so'
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
        rm Magisk-26.4.apk

        # åˆ›å»ºè„šæœ¬
        cat > make_boot.sh << 'EOF'
        #!/bin/bash
        echo "KernelSUæç®€å†…æ ¸æ‰“åŒ…å·¥å…·"
        echo "========================"

        if [ ! -f boot.img ]; then
          echo "é”™è¯¯ï¼šéœ€è¦åŸç‰ˆboot.img"
          exit 1
        fi

        # æ£€æŸ¥å†…æ ¸æ–‡ä»¶
        if [ ! -f Image.gz-dtb ] || [ $(stat -c%s Image.gz-dtb) -lt 1000 ]; then
          echo "è­¦å‘Šï¼šå†…æ ¸æ–‡ä»¶å¯èƒ½æœ‰é—®é¢˜"
          echo "å¤§å°ï¼š$(ls -lh Image.gz-dtb)"
        fi

        ./magiskboot unpack boot.img
        cp Image.gz-dtb kernel
        ./magiskboot repack boot.img

        echo ""
        echo "ç”Ÿæˆï¼šnew-boot.img"
        echo ""
        echo "åˆ·å…¥ï¼šfastboot flash boot new-boot.img"
        echo ""
        echo "âš ï¸ è¿™æ˜¯å®éªŒæ€§å†…æ ¸ï¼Œè¯·å…ˆå¤‡ä»½ï¼"
        EOF
        chmod +x make_boot.sh

        # åˆ›å»ºè¯´æ˜
        cat > README.txt << 'EOF'
        KernelSUæç®€å†…æ ¸ - å®éªŒç‰ˆ

        çŠ¶æ€ï¼šè¿™æ˜¯æ¿€è¿›ä¿®å¤ç‰ˆæœ¬
        - å¯èƒ½æˆåŠŸç¼–è¯‘äº†éƒ¨åˆ†åŠŸèƒ½
        - å¯èƒ½ç¼ºå°‘æŸäº›é©±åŠ¨
        - ä»…ç”¨äºæµ‹è¯•

        ä½¿ç”¨é£é™©ï¼š
        1. å¯èƒ½æ— æ³•å¯åŠ¨
        2. å¯èƒ½æ›´è€—ç”µ
        3. æŸäº›åŠŸèƒ½å¯èƒ½å¤±æ•ˆ

        åˆ·å…¥å‰å¿…é¡»ï¼š
        1. å¤‡ä»½åŸç‰ˆboot.img
        2. å‡†å¤‡æ•‘ç –å·¥å…·
        3. çŸ¥é“å¦‚ä½•è¿›å…¥fastboot

        å¦‚æœå˜ç –ï¼š
        fastboot flash boot boot_backup.img
        EOF

        ls -lah

    - name: ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: KernelSU-Experimental
        path: output/

    - name: æ‘˜è¦
      run: |
        echo "# ğŸ§ª å®éªŒæ€§å†…æ ¸ç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "$HOME/kernel/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "## âœ… ç¼–è¯‘å¯èƒ½æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰¾åˆ°Image.gz-dtbæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        elif [ -f "$HOME/kernel/arch/arm64/boot/Image" ]; then
          echo "## âš ï¸ éƒ¨åˆ†æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- åªæ‰¾åˆ°Imageæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ ç¼–è¯‘çŠ¶æ€æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- æœªæ‰¾åˆ°æ ‡å‡†å†…æ ¸æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš ï¸ é‡è¦æé†’" >> $GITHUB_STEP_SUMMARY
        echo "1. è¿™æ˜¯å®éªŒæ€§ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
        echo "2. å¯èƒ½æ— æ³•æ­£å¸¸å¯åŠ¨" >> $GITHUB_STEP_SUMMARY
        echo "3. å¿…é¡»å…ˆå¤‡ä»½åŸç‰ˆboot.img" >> $GITHUB_STEP_SUMMARY
