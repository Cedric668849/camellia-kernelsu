name: Build Camellia KernelSU Kernel

on:
  workflow_dispatch:
    inputs:
      kernelsu_version:
        description: 'KernelSUç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æœ€å¤§åŒ–æž„å»ºç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update

        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt install -y \
          bc bison build-essential ccache curl flex \
          git gnupg gperf liblz4-tool \
          libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev python3 python3-pip device-tree-compiler wget

        # å°è¯•å®‰è£…äº¤å‰ç¼–è¯‘å™¨ï¼ˆå…¼å®¹å¤šä¸ªç‰ˆæœ¬ï¼‰
        sudo apt install -y gcc-aarch64-linux-gnu || \
        sudo apt install -y gcc-12-aarch64-linux-gnu || \
        sudo apt install -y gcc-11-aarch64-linux-gnu || \
        sudo apt install -y gcc-10-aarch64-linux-gnu

        # ç¡®è®¤å®‰è£…çš„GCCç‰ˆæœ¬
        aarch64-linux-gnu-gcc --version || echo "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬"

    - name: è®¾ç½®ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: "2G"

    - name: å…‹éš†å†…æ ¸æºç 
      run: |
        git clone https://github.com/MiCode/Xiaomi_Kernel_OpenSource.git -b camellia-r-oss kernel --depth=1
        echo "å†…æ ¸æºç å…‹éš†å®Œæˆ"

    - name: å…‹éš†KernelSU
      run: |
        if [ -n "${{ github.event.inputs.kernelsu_version }}" ]; then
          git clone https://github.com/tiann/KernelSU.git -b ${{ github.event.inputs.kernelsu_version }} --depth=1
        else
          git clone https://github.com/tiann/KernelSU.git --depth=1
        fi
        cd KernelSU
        echo "KernelSUç‰ˆæœ¬: $(git describe --tags --always)"
        cd ..
        echo "KernelSUç›®å½•å†…å®¹:"
        ls -la KernelSU/kernel/

    - name: é›†æˆKernelSUåˆ°å†…æ ¸
      run: |
        cd kernel

        # ä½¿ç”¨ç»å¯¹è·¯å¾„åˆ›å»ºç¬¦å·é“¾æŽ¥
        KERNELSU_PATH="$(pwd)/../KernelSU/kernel"
        echo "KernelSUè·¯å¾„: $KERNELSU_PATH"

        # åˆ›å»ºç¬¦å·é“¾æŽ¥
        ln -sf "$KERNELSU_PATH" drivers/kernelsu

        # éªŒè¯é“¾æŽ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ -e "drivers/kernelsu" ]; then
          echo "KernelSUé“¾æŽ¥åˆ›å»ºæˆåŠŸ"
          ls -la drivers/kernelsu/
        else
          echo "ç¬¦å·é“¾æŽ¥å¤±è´¥ï¼Œå°è¯•ç›´æŽ¥å¤åˆ¶"
          cp -r ../KernelSU/kernel drivers/kernelsu
          if [ -d "drivers/kernelsu" ]; then
            echo "ç›´æŽ¥å¤åˆ¶æˆåŠŸ"
          else
            echo "é”™è¯¯ï¼šæ— æ³•åˆ›å»ºkernelsuç›®å½•"
            exit 1
          fi
        fi

        # ä¿®æ”¹Makefile
        if ! grep -q "kernelsu" drivers/Makefile; then
          echo 'obj-y += kernelsu/' >> drivers/Makefile
          echo "å·²æ·»åŠ kernelsuåˆ°Makefile"
        else
          echo "Makefileå·²åŒ…å«kernelsu"
        fi

        # ä¿®æ”¹Kconfig
        if ! grep -q "kernelsu" drivers/Kconfig; then
          echo 'source "drivers/kernelsu/Kconfig"' >> drivers/Kconfig
          echo "å·²æ·»åŠ kernelsuåˆ°Kconfig"
        else
          echo "Kconfigå·²åŒ…å«kernelsu"
        fi

        echo "KernelSUé›†æˆå®Œæˆ"

    - name: é…ç½®å†…æ ¸
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

        # ä½¿ç”¨é»˜è®¤é…ç½®
        make camellia_defconfig

        # æ·»åŠ KernelSUé…ç½®
        cat >> .config << EOF
        CONFIG_KPROBES=y
        CONFIG_HAVE_KPROBES=y
        CONFIG_KPROBE_EVENTS=y
        CONFIG_KSU=y
        EOF

        # æ›´æ–°é…ç½®
        make olddefconfig

        echo "æ£€æŸ¥KernelSUé…ç½®:"
        grep -E "CONFIG_KSU|CONFIG_KPROBES" .config || echo "è­¦å‘Šï¼šKernelSUé…ç½®å¯èƒ½æœªå¯ç”¨"

    - name: ç¼–è¯‘å†…æ ¸
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export USE_CCACHE=1
        export CCACHE_DIR=~/.ccache

        echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make -j$(nproc) Image.gz-dtb

        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶:"
        ls -lh arch/arm64/boot/Image.gz-dtb

    - name: å‡†å¤‡æ‰“åŒ…å·¥å…·
      run: |
        # ä¸‹è½½magiskboot
        wget -q https://github.com/topjohnwu/Magisk/releases/latest/download/Magisk-26.4.apk
        unzip -j Magisk-*.apk 'lib/x86_64/libmagiskboot.so' -d .
        mv libmagiskboot.so magiskboot
        chmod +x magiskboot
        rm Magisk-*.apk

        # åˆ›å»ºæ‰“åŒ…è„šæœ¬
        cat > pack_boot.sh << 'SCRIPT_END'
        #!/bin/bash
        echo "===== Boot.imgæ‰“åŒ…è¯´æ˜Ž ====="
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•ï¼š"
        echo "1. ä»Žæ‰‹æœºæå–åŽŸå§‹boot.img:"
        echo "   adb shell su -c 'dd if=/dev/block/by-name/boot of=/sdcard/boot.img'"
        echo "   adb pull /sdcard/boot.img"
        echo ""
        echo "2. è§£åŒ…åŽŸå§‹boot.img:"
        echo "   ./magiskboot unpack boot.img"
        echo ""
        echo "3. æ›¿æ¢å†…æ ¸:"
        echo "   cp Image.gz-dtb kernel"
        echo ""
        echo "4. é‡æ–°æ‰“åŒ…:"
        echo "   ./magiskboot repack boot.img"
        echo "   (ç”Ÿæˆnew-boot.img)"
        echo ""
        echo "5. åˆ·å…¥æ–°å†…æ ¸:"
        echo "   adb reboot bootloader"
        echo "   fastboot flash boot new-boot.img"
        echo "   fastboot reboot"
        SCRIPT_END
        chmod +x pack_boot.sh

    - name: æ”¶é›†ç¼–è¯‘ä¿¡æ¯
      run: |
        cat > build_info.txt << 'INFO_END'
        ===== KernelSUå†…æ ¸ç¼–è¯‘ä¿¡æ¯ =====

        ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        è®¾å¤‡: çº¢ç±³Note 10 (camellia)
        å¤„ç†å™¨: MediaTek Dimensity 700
        Androidç‰ˆæœ¬: 11 (R)

        KernelSUç‰ˆæœ¬: $(cd KernelSU && git describe --tags --always)
        å†…æ ¸æ–‡ä»¶: Image.gz-dtb
        æ–‡ä»¶å¤§å°: $(ls -lh kernel/arch/arm64/boot/Image.gz-dtb | awk '{print $5}')

        GCCç‰ˆæœ¬:
        $(aarch64-linux-gnu-gcc --version | head -n1)

        ä½¿ç”¨è¯´æ˜Ž:
        1. ä¸‹è½½æœ¬åŽ‹ç¼©åŒ…
        2. è§£åŽ‹èŽ·å¾—Image.gz-dtbå’Œå·¥å…·
        3. æŒ‰ç…§pack_boot.shä¸­çš„è¯´æ˜Žæ‰“åŒ…boot.img
        4. åˆ·å…¥æ‰‹æœºæµ‹è¯•

        æ³¨æ„ï¼šè¯·å…ˆå¤‡ä»½åŽŸå§‹boot.imgï¼
        INFO_END

        # æ‰§è¡Œå˜é‡æ›¿æ¢
        eval "echo \"$(cat build_info.txt)\"" > build_info_final.txt
        mv build_info_final.txt build_info.txt

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: kernelsu-camellia
        path: |
          kernel/arch/arm64/boot/Image.gz-dtb
          magiskboot
          pack_boot.sh
          build_info.txt

    - name: æ˜¾ç¤ºç¼–è¯‘æ‘˜è¦
      run: |
        echo "## ðŸŽ‰ ç¼–è¯‘æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± è®¾å¤‡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- è®¾å¤‡: çº¢ç±³Note 10 (camellia)" >> $GITHUB_STEP_SUMMARY
        echo "- å¤„ç†å™¨: MediaTek Dimensity 700" >> $GITHUB_STEP_SUMMARY
        echo "- Androidç‰ˆæœ¬: 11 (R)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ç¼–è¯‘äº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- å†…æ ¸æ–‡ä»¶: Image.gz-dtb" >> $GITHUB_STEP_SUMMARY
        echo "- æ–‡ä»¶å¤§å°: $(ls -lh kernel/arch/arm64/boot/Image.gz-dtb | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "- KernelSU: âœ… å·²é›†æˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "è¯·åœ¨Actionsé¡µé¢ä¸‹è½½ **kernelsu-camellia.zip**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ æ³¨æ„äº‹é¡¹" >> $GITHUB_STEP_SUMMARY
        echo "1. åˆ·å…¥å‰è¯·å¤‡ä»½åŽŸå§‹boot.img" >> $GITHUB_STEP_SUMMARY
        echo "2. éœ€è¦è§£é”Bootloader" >> $GITHUB_STEP_SUMMARY
        echo "3. é¦–æ¬¡åˆ·å…¥å¯èƒ½éœ€è¦æ¸…é™¤æ•°æ®" >> $GITHUB_STEP_SUMMARY
